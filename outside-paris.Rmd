---
title: "Quitter Paris, mais pour aller où ?"
author: "Paul Charlet"
output:
   html_document:
      self_contained: true
      keep_md: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
library(leaflet)
```

## Intro

Quelle est la meilleure ville pour s'installer en dehors de Paris ? Chacun a sa meilleure réponse, basée sur un certain nombre de critères comme la météo, l'emploi, l'éloignement, le coût de la vie, ...

Je propose dans cet essai d'aller récupérer ces données et de les visualiser.

## Quelles sont les plus grandes villes de France ?

Nous allons utiliser Wikidata pour récupérer les 20 plus grandes villes de France, puis nettoyer les coordonnées pour pouvoir les utiliser par la suite. On obtient le tableau ci-dessous (Paris est enregistrée séparément). Pour voir les fonctions utilisées, vous pouvez retrouver le fichier sur le repo.

```{r getCities, message=FALSE}
source("getCities.R")
cities <- getCities(2,21)
paris <- getCities(1,1)
kable(cities[1:6,-3],format="markdown")
```

Soit, visuellement en utilisant le package leaflet.

```{r franceMap}
francemap <- leaflet() %>%
    addTiles() %>%
    addMarkers(lng = cities$lon, lat = cities$lat, popup = cities$cityLabel)
francemap
```

## Critère de distance

Nous allons commencer par calculer les distances entre chacune de ces villes et Paris. Nous commencerons par des distances à vol d'oiseau. Le contenu de la function `straightDistance()` est disponible dans le repo.

```{r straightDistance}
source("straightDistance.R")
distanceToParis <- vector()
for (i in 1:length(cities[,1])){
    distanceToParis[i] <- straightDistance(cities$lon[i],cities$lat[i],paris$lon,paris$lat)
}
cities <- cbind(cities,distanceToParis)
kable(cities[1:6,c(1,6)], format = "markdown")
```

## Critère d'activité culturelle

On trouve sur data.gouv.fr un agenda de l'offre culturelle par ville (https://www.data.gouv.fr/s/resources/agenda-de-l-offre-culturelle/community/20150724-153623/Agenda24072015.csv). Malheureusement, ces données datent de 2015 et il n'y a pas de jeu de données plus récent. Récupérons le nombre d'événements culturels.

Le lieu dans ce fichier est précisé en latitude/longitude. Il serait intéressant d'obtenir le nombre d'événements culturels dans un rayon de 10km plutôt que purement dans la ville. Malheureusement, cette donnée n'est présente que dans moins de 10% des cas.  
Utilisons donc une fonction de geocoding pour récupérer les coordonnées de chaque ville hébergeant chaque événement. Nous avons 34000 adresses à géocoder, ce qui reste dans les limites d'usage de l'API Google : [https://developers.google.com/maps/documentation/geocoding/usage-and-billing]. Il faut néanmoins donner ses coordonnées CB, ce que je ne suis pas prêt à faire. Nous utiliserons l'équivalent chez OpenStreetMaps (Nominatim), dont nous cacherons les requètes pour ne pas surcharger l'API : [https://operations.osmfoundation.org/policies/nominatim/]

La fonction `getCulture()` va calculer pour chaque point du calendrier de l'offre culturelle, si il est dans le rayon de chaque ville. Puis il additionnera le nombre de lignes trouvées pour chaque ville.  
Nous allons pouvoir réutiliser la fonction de calcul de distances.
```{r culturalActivity}
cultureAgendaLink <- "https://www.data.gouv.fr/s/resources/agenda-de-l-offre-culturelle/community/20150724-153623/Agenda24072015.csv"
source("cultureEvents.R")
events <- getCultureEvents(cultureAgendaLink,cities)
kable(events[1:6], format = "markdown")
```

